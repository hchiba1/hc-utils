#!/usr/bin/perl -w
use strict;
use File::Basename;
use Getopt::Std;
my $PROGRAM = basename $0;
my $USAGE=
"Usage: $PROGRAM [-d] FILE
-d: debug
";

my %OPT;
getopts('d', \%OPT);

if (!@ARGV) {
    print STDERR $USAGE;
    exit 1;
}
my $FILE = shift @ARGV;

if (! -e $FILE) {
    die "ERROR: $FILE: $!";
}

my $DIR = "";
my $BINARY_FILE = "";
if ($FILE =~ /^(.+)\.nim$/) {
    my $prefix = $1;
    my $DIR = dirname($prefix);
    my $basename = basename($prefix);
    if ($^O eq "linux") {
        $DIR .= "/linux";
    } elsif ($^O eq "darwin") {
        $DIR .= "/mac"
    } elsif ($^O eq "dos") {
        $DIR .= "/win"
    } else {
        die;
    }
    if (! -e $DIR) {
        mkdir($DIR);
    }
    $BINARY_FILE = "$DIR/$basename";
} else {
    die $USAGE;
}

if ($OPT{d}) {
    system "nim compile --run --out:$BINARY_FILE $FILE";
} elsif (-f $BINARY_FILE && (stat $BINARY_FILE)[9] > (stat $FILE)[9]) {
    system "$BINARY_FILE @ARGV";
} else {
    my $result = `nim compile --out:$BINARY_FILE $FILE 2>&1`;
    if ($? >> 8) {
        print STDERR $result;
        exit($? >> 8);
    }
    system "$BINARY_FILE @ARGV";
}
